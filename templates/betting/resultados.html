{% extends 'base.html' %}
{% load currency_filters %}
{% block title %}Resultados das Apostas{% endblock %}

{% block content %}

<style>
    /* Estilos base para Dark Mode */
    .results-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #1f2937;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        font-family: 'Inter', sans-serif;
        color: #f3f4f6;
    }

    h1 {
        text-align: center;
        color: #93c5fd;
        margin-bottom: 30px;
        padding-bottom: 10px;
        border-bottom: 1px solid #374151;
    }

    h2 {
        color: #93c5fd;
        margin-top: 30px;
        margin-bottom: 15px;
        padding-left: 5px;
        font-size: 1.6em;
    }

    /* Formul√°rio */
    .config-form {
        background-color: #111827;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: flex-end;
        border: 1px solid #374151;
        flex-wrap: wrap;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .form-group label {
        color: #9ca3af;
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    .form-group input,
    .form-group select {
        background-color: #374151;
        border: 1px solid #4b5563;
        border-radius: 4px;
        padding: 8px;
        color: #f3f4f6;
        font-size: 1em;
        width: 100%;
    }

    .submit-button {
        background-color: #60a5fa;
        color: #111827;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
        min-width: 120px;
    }

    .submit-button:hover {
        background-color: #3b82f6;
    }

    /* Filtros */
    .filter-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-button {
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.2s;
        border: 1px solid transparent;
        color: #d1d5db;
        background-color: #374151;
    }

    .filter-button:hover {
        transform: translateY(-1px);
        opacity: 0.9;
    }

    .filter-button.active {
        background-color: #60a5fa;
        color: #111827;
        border-color: #3b82f6;
    }

    /* Pagina√ß√£o */
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }

    .pagination-controls button {
        background-color: #374151;
        color: #d1d5db;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .pagination-controls button:hover:not(:disabled) {
        background-color: #4b5563;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .current-page {
        color: #60a5fa;
        font-weight: bold;
    }

    /* Painel de Insights */
    .insights-panel {
        background-color: #111827;
        border: 2px solid #3b82f6;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        text-align: center;
    }

    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-item {
        background-color: #374151;
        padding: 15px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .stat-value {
        font-size: 1.4em;
        font-weight: 700;
        margin-top: 5px;
    }

    .profit-value {
        font-size: 2.5em;
        font-weight: 900;
    }

    /* Cards */
    .match-result-card {
        background-color: #111827;
        border: 1px solid #374151;
        border-left: 5px solid #60a5fa;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .match-result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
    }

    .match-result-card.hidden {
        display: none !important;
    }

    .status-badge {
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        min-width: 80px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
</style>

<div class="results-container">
    <h1>üèÜ Resultados e Simula√ß√£o de Lucro</h1>

    <!-- FORM COM FILTRO DE LIGA -->
    <form method="GET" class="config-form">
        <div class="form-group">
            <label for="odd">Odd M√©dia:</label>
            <input type="number" step="0.01" min="1" name="odd"
                   value="{{ insights.odd_media|floatformat:2 }}" required>
        </div>

        <div class="form-group">
            <label for="stake">Stake Fixa (R$):</label>
            <input type="number" step="0.01" min="1" name="stake"
                   value="{{ insights.stake|floatformat:2 }}" required>
        </div>

        <div class="form-group">
            <label for="liga">Liga:</label>
            <select name="liga">
                <option value="">Todas</option>
                {% for l in ligas %}
                    <option value="{{ l.id }}"
                        {% if insights.liga_selecionada == l.name %}selected{% endif %}>
                        {{ l.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="submit-button">Aplicar</button>
    </form>

    <!-- PAINEL DE INSIGHTS -->
    <div class="insights-panel">
        <h3>üìä Performance Geral</h3>

        <div class="insights-grid">
            <div class="stat-item"><p>Total:</p><span class="stat-value">{{ insights.total_bets }}</span></div>
            <div class="stat-item"><p>GREEN:</p><span class="stat-value" style="color:#34d399">{{ insights.greens }}</span></div>
            <div class="stat-item"><p>RED:</p><span class="stat-value" style="color:#f87171">{{ insights.reds }}</span></div>
            <div class="stat-item"><p>PUSH:</p><span class="stat-value" style="color:#fbbf24">{{ insights.pushes }}</span></div>
            <div class="stat-item"><p>Winrate:</p><span class="stat-value">{{ insights.winrate|floatformat:2 }}%</span></div>
            <div class="stat-item"><p>Odd M√©dia:</p><span class="stat-value">{{ insights.odd_media|currency_brl }}</span></div>
            <div class="stat-item"><p>Stake:</p><span class="stat-value">{{ insights.stake|currency_brl }}</span></div>
        </div>

        <h3 style="margin-top:20px;">üí∞ Lucro</h3>
        <span class="profit-value" style="color:{% if insights.lucro >= 0 %}#34d399{% else %}#f87171{% endif %};">
            {{ insights.lucro|currency_brl }}
        </span>
    </div>

    <h2>Detalhes dos Jogos (<span id="visible-count">{{ insights.total_bets }}</span>)</h2>

    <!-- FILTROS -->
    <div class="filter-controls">
        <button class="filter-button active" data-filter="ALL">Todos</button>
        <button class="filter-button status-GREEN" data-filter="GREEN">GREEN ({{ insights.greens }})</button>
        <button class="filter-button status-RED" data-filter="RED">RED ({{ insights.reds }})</button>
        <button class="filter-button status-PUSH" data-filter="PUSH">PUSH ({{ insights.pushes }})</button>
    </div>

    <!-- LISTA -->
    <div id="results-list">
        {% for r in resultados %}
            <a href="{% url 'match_detail' r.match.id %}">
                <div class="match-result-card" data-status="{{ r.status }}">
                    <div class="match-info">
                        <strong>
                            {{ r.match.home_team.name }}
                            <span class="text-xl font-extrabold">{{ r.match.home_team_score }}</span>
                            x
                            <span class="text-xl font-extrabold">{{ r.match.away_team_score }}</span>
                            {{ r.match.away_team.name }}
                        </strong>
                        <div class="bet-info">
                            Aposta: <strong>{{ r.tipo }} {{ r.principal }}</strong><br>
                            Placar Final: <strong>{{ r.placar }}</strong>
                        </div>
                    </div>
                    <div class="status-badge status-{{ r.status }}">{{ r.status }}</div>
                </div>
            </a>
        {% empty %}
            <p style="text-align:center; padding:20px;">Nenhum resultado encontrado.</p>
        {% endfor %}
    </div>

    <!-- PAGINA√á√ÉO -->
    <div class="pagination-controls" id="pagination-controls">
        <button id="prev-page">Anterior</button>
        <span class="current-page">P√°gina <span id="current-page-number">1</span> de <span id="total-pages">1</span></span>
        <button id="next-page">Pr√≥xima</button>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const resultsList = document.getElementById('results-list');
        const cards = Array.from(resultsList.querySelectorAll('.match-result-card'));
        const filterButtons = document.querySelectorAll('.filter-button');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const currentPageSpan = document.getElementById('current-page-number');
        const totalPagesSpan = document.getElementById('total-pages');
        const visibleCountSpan = document.getElementById('visible-count');

        const itemsPerPage = 10;
        let currentPage = 1;
        let currentFilter = 'ALL';

        function updatePaginationControls(totalPages) {
            totalPagesSpan.textContent = totalPages;
            currentPageSpan.textContent = currentPage;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        function filterAndPaginate() {
            let visibleCards = 0;

            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const isVisible = currentFilter === 'ALL' || status === currentFilter;

                card.style.display = isVisible ? 'flex' : 'none';

                if (isVisible) visibleCards++;
            });

            visibleCountSpan.textContent = visibleCards;

            const totalPages = Math.ceil(visibleCards / itemsPerPage);
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            let start = (currentPage - 1) * itemsPerPage;
            let end = start + itemsPerPage;
            let index = 0;

            cards.forEach(card => {
                if (card.style.display !== 'none') {
                    card.classList.toggle('hidden', !(index >= start && index < end));
                    index++;
                }
            });

            updatePaginationControls(totalPages);
        }

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                currentFilter = button.dataset.filter;
                currentPage = 1;
                filterAndPaginate();
            });
        });

        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                filterAndPaginate();
            }
        });

        nextButton.addEventListener('click', () => {
            const visibleCards = cards.filter(card => card.style.display !== 'none').length;
            const totalPages = Math.ceil(visibleCards / itemsPerPage);

            if (currentPage < totalPages) {
                currentPage++;
                filterAndPaginate();
            }
        });

        filterAndPaginate();
    });
</script>

{% endblock %}
