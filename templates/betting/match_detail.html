{% extends 'base.html' %}
{% block title %}{{ match.home_team }} vs {{ match.away_team }} - An√°lise{% endblock %}
{% load currency_filters %}

{% block content %}

<style>
    :root {
        --bg-dark-elevated: #1e1e2d;
        --border-color: rgba(255, 255, 255, 0.1);
        --primary-color: #3699ff;
        --success-color: #00bfa5;
        --danger-color: #f64e60;
        --warning-color: #ffc107;
        --text-muted: #b5b5c3;
    }

    /* Utilit√°rios de Layout */
    .dashboard-card {
        background-color: var(--bg-dark-elevated);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .card-header-custom {
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.25rem;
        background: rgba(0, 0, 0, 0.1);
    }

    /* Scoreboard */
    .scoreboard-card {
        background: linear-gradient(180deg, #2b2b40 0%, #1e1e2d 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        position: relative;
    }
    .score-val { font-size: 3.5rem; font-weight: 800; color: #fff; line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .team-name-lg { font-size: 1.3rem; font-weight: 700; color: #fff; letter-spacing: 0.5px; }

    /* Live Badge com Pulso */
    .live-badge {
        background: rgba(246, 78, 96, 0.15);
        color: var(--danger-color);
        border: 1px solid rgba(246, 78, 96, 0.3);
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 800;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        animation: border-pulse 2s infinite;
    }
    .live-dot { width: 8px; height: 8px; background-color: var(--danger-color); border-radius: 50%; }

    /* Barras de Press√£o */
    .pressure-wrapper { background: #121214; height: 10px; border-radius: 5px; display: flex; overflow: hidden; margin: 15px 0; }
    .pressure-bar { height: 100%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .p-home { background: linear-gradient(90deg, #3699ff 0%, #00d2ff 100%); }
    .p-away { background: linear-gradient(90deg, #ff4b2b 0%, #f64e60 100%); }

    /* Estat√≠sticas */
    .stat-row { margin-bottom: 14px; }
    .stat-header { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; color: var(--text-muted); }
    .stat-progress-bg { background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; display: flex; overflow: hidden; }
    .stat-fill { height: 100%; transition: width 0.6s ease; }

    /* Odds Chips */
    .odds-choice {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 10px;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .odds-choice:hover { transform: translateY(-2px); border-color: var(--primary-color); background: rgba(54, 153, 255, 0.05); }
    .odds-val { font-size: 1.2rem; font-weight: 700; color: #fff; }
    .odds-prob { font-size: 0.75rem; opacity: 0.7; margin-top: 2px; }

    /* Anima√ß√µes */
    @keyframes border-pulse {
        0% { box-shadow: 0 0 0 0 rgba(246, 78, 96, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(246, 78, 96, 0); }
        100% { box-shadow: 0 0 0 0 rgba(246, 78, 96, 0); }
    }
</style>

<div class="container-fluid px-md-5 py-4">

    <a href="{% url 'matches_list' %}" class="btn btn-outline-secondary btn-sm mb-4 border-0 hover-white">
        <i class="bi bi-arrow-left me-1"></i> Voltar √† Lista
    </a>

    <div class="row mb-4">
        <div class="col-12">
            <div class="scoreboard-card text-center shadow-lg">
                <div class="mb-3">
                    {% if match.finalizado %}
                        <span class="badge bg-secondary text-white px-3 py-2">ENCERRADO</span>
                    {% else %}
                        <div class="live-badge">
                            <span class="live-dot"></span> AO VIVO <span class="ms-1 text-white opacity-75 minute-badge">{{ live_analysis.analysis.minute|default:"-" }}'</span>
                        </div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-center align-items-center gap-3 gap-md-5">
                    <div class="text-end flex-fill">
                        <h2 class="team-name-lg mb-0 d-none d-md-block">{{ match.home_team }}</h2>
                        <h2 class="team-name-lg mb-0 d-md-none">{{ match.home_team|truncatechars:10 }}</h2>
                    </div>

                    <div class="d-flex align-items-center gap-3 bg-dark bg-opacity-50 px-4 py-2 rounded-4 border border-secondary border-opacity-10">
                        <span class="score-val home-score">{{ match.home_team_score|default:"0" }}</span>
                        <span class="text-muted fs-4 opacity-25">:</span>
                        <span class="score-val away-score">{{ match.away_team_score|default:"0" }}</span>
                    </div>

                    <div class="text-start flex-fill">
                        <h2 class="team-name-lg mb-0 d-none d-md-block">{{ match.away_team }}</h2>
                        <h2 class="team-name-lg mb-0 d-md-none">{{ match.away_team|truncatechars:10 }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-7">

            {% if live_analysis %}
            <div class="dashboard-card">
                <div class="card-header-custom">
                    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-speedometer2 text-danger me-2"></i>Momentum & Press√£o (15')</h6>
                </div>
                <div class="card-body p-4">

                    <div class="mb-4">
                        <div class="d-flex justify-content-between small fw-bold text-muted mb-1">
                            <span>HOME <span class="text-primary" id="pressure-val-home">50</span></span>
                            <span>AWAY <span class="text-danger" id="pressure-val-away">50</span></span>
                        </div>
                        <div class="pressure-wrapper">
                            <div class="pressure-bar p-home" id="pressure-bar-home" style="width: 50%"></div>
                            <div class="pressure-bar p-away" id="pressure-bar-away" style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="row text-center mb-4 g-2">
                        <div class="col-4">
                            <div class="bg-secondary bg-opacity-10 rounded p-3 h-100">
                                <span class="d-block text-white fw-bold fs-5 live-corners">-</span>
                                <small class="text-muted text-uppercase" style="font-size: 0.65rem;">Cantos (15')</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-secondary bg-opacity-10 rounded p-3 h-100">
                                <span class="d-block text-white fw-bold fs-5 live-shots">-</span>
                                <small class="text-muted text-uppercase" style="font-size: 0.65rem;">Chutes (15')</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-secondary bg-opacity-10 rounded p-3 h-100">
                                <span class="d-block text-white fw-bold fs-5 live-xg">-</span>
                                <small class="text-muted text-uppercase" style="font-size: 0.65rem;">xG Total</small>
                            </div>
                        </div>
                    </div>

                    <div class="bg-dark bg-opacity-50 p-3 rounded border border-warning border-opacity-10">
                        <h6 class="text-warning small fw-bold text-uppercase mb-2"><i class="bi bi-cpu me-1"></i> Insights da IA:</h6>
                        <div class="live-insights-list d-flex flex-column gap-2">
                            <div class="text-muted small fst-italic">Analisando dados em tempo real...</div>
                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            <div class="dashboard-card">
                <div class="card-header-custom">
                    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-bar-chart-fill text-primary me-2"></i>Estat√≠sticas do Jogo</h6>
                </div>
                <div class="card-body p-4">
                    {% if stat_labels %}
                        {% for key, label in stat_labels %}
                        <div class="stat-row" data-stat-key="{{ key }}">
                            <div class="stat-header">
                                <span class="{{ key }}-home text-primary fw-bold">0</span>
                                <span class="text-uppercase opacity-75">{{ label }}</span>
                                <span class="{{ key }}-away text-danger fw-bold">0</span>
                            </div>
                            <div class="stat-progress-bg">
                                <div class="stat-fill fill-home bg-primary" style="width: 50%"></div>
                                <div class="stat-fill fill-away bg-danger" style="width: 50%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted py-4">Aguardando dados...</p>
                    {% endif %}
                </div>
            </div>

            {% if pregame_form.home or pregame_form.away %}
            <div class="dashboard-card">
                <div class="card-header-custom">
                    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-graph-up-arrow text-info me-2"></i>Forma & Classifica√ß√£o</h6>
                </div>
                <div class="card-body p-3">
                    {% if pregame_edge.edge %}
                    <div class="alert bg-info bg-opacity-10 border-0 text-info mb-3 d-flex gap-2 align-items-center">
                        <i class="bi bi-info-circle-fill"></i>
                        <div>
                            <strong>Insight Pr√©-Jogo:</strong> {{ pregame_edge.reason }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex flex-column gap-3">
                        {% if pregame_form.home %}
                        <div class="p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary">MANDANTE</span>
                                <span class="small text-muted">Pos: <b>{{ pregame_form.home.position }}</b> | Pts: <b>{{ pregame_form.home.points }}</b></span>
                            </div>
                            <div class="d-flex gap-1">
                                {% for r in pregame_form.home.form %}
                                    <span class="badge {% if r == 'W' %}bg-success{% elif r == 'L' %}bg-danger{% else %}bg-secondary{% endif %} bg-opacity-25 text-white border border-white border-opacity-10">{{ r }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if pregame_form.home and pregame_form.away %}<hr class="border-secondary border-opacity-10 my-0">{% endif %}

                        {% if pregame_form.away %}
                        <div class="p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-danger bg-opacity-10 text-danger">VISITANTE</span>
                                <span class="small text-muted">Pos: <b>{{ pregame_form.away.position }}</b> | Pts: <b>{{ pregame_form.away.points }}</b></span>
                            </div>
                            <div class="d-flex gap-1">
                                {% for r in pregame_form.away.form %}
                                    <span class="badge {% if r == 'W' %}bg-success{% elif r == 'L' %}bg-danger{% else %}bg-secondary{% endif %} bg-opacity-25 text-white border border-white border-opacity-10">{{ r }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <div class="col-lg-5">

            {% if preview %}
            <div class="dashboard-card border-primary border-opacity-25">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-robot text-primary me-2"></i>Modelo Matem√°tico</h6>
                    <span class="badge bg-primary bg-opacity-25 text-primary">v2.0</span>
                </div>
                <div class="card-body p-4">
                    <div class="text-center py-3 mb-3 bg-dark rounded border border-dashed border-secondary border-opacity-25">
                        <small class="text-muted text-uppercase d-block mb-1">Gols Esperados (xG)</small>
                        <span class="display-5 fw-bold text-white">{{ preview.expected_goals|default:"-" }}</span>
                    </div>
                    <div class="text-center py-3 mb-3 bg-dark rounded border border-dashed border-secondary border-opacity-25">
                        <small class="text-muted text-uppercase d-block mb-1">Chance de Over canto 8.5</small>
                        <span class="display-5 fw-bold text-white">{{ preview.corners_over_8_5|default:"-" }}</span>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-3 rounded bg-secondary bg-opacity-10 text-center h-100">
                                <small class="text-muted d-block mb-1">Prob. Over 2.5</small>
                                <span class="fw-bold text-success fs-5">{{ preview.over_2_5|default:"0" }}%</span>
                                <div class="progress mt-2" style="height: 3px;">
                                    <div class="progress-bar bg-success" style="width: {{ preview.over_2_5|default:'0' }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded bg-secondary bg-opacity-10 text-center h-100">
                                <small class="text-muted d-block mb-1">Prob. BTTS</small>
                                <span class="fw-bold text-warning fs-5">{{ preview.btts|default:"0" }}%</span>
                                <div class="progress mt-2" style="height: 3px;">
                                    <div class="progress-bar bg-warning" style="width: {{ preview.btts|default:'0' }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if bet_suggestions %}
                <div class="dashboard-card border-success border-opacity-25 mt-3">
                    <div class="card-header-custom">
                        <h6 class="mb-0 text-white fw-bold">
                            <i class="bi bi-cash-coin text-success me-2"></i>
                            Entradas Sugeridas
                        </h6>
                    </div>

                    <div class="card-body p-3 small">

                        <p>‚öΩ <strong>Primeiro gol:</strong>
                            <span class="text-success">{{ bet_suggestions.first_goal }}</span>
                        </p>

                        <p>üö© <strong>Mais escanteios:</strong>
                            {{ bet_suggestions.corners_side }}
                        </p>

                        <p>üìê <strong>Escanteios estimados:</strong>
                            {{ bet_suggestions.corners_total }} ‚Üí
                            <span class="text-info">{{ bet_suggestions.corners_line }}</span>
                        </p>

                        <p>üü® <strong>Cart√µes:</strong>
                            {{ bet_suggestions.cards_total }} ‚Üí
                            <span class="text-warning">{{ bet_suggestions.cards_market }}</span>
                        </p>

                    </div>
                </div>
            {% endif %}

            <div id="odds-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2 small">Carregando cota√ß√µes...</p>
            </div>
            <div id="odds-container-sidebar"></div>

            {% if streak_analysis %}
            <div class="dashboard-card border-warning border-opacity-25">
                <div class="card-header-custom">
                    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-fire text-warning me-2"></i>Tend√™ncias</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for item in streak_analysis.general %}
                        {% if item.hot_streak %}
                        <div class="list-group-item bg-transparent text-white-50 px-3 py-3 border-secondary border-opacity-10">
                            <div class="d-flex gap-3 align-items-start">
                                <i class="bi bi-lightning-charge-fill text-warning mt-1"></i>
                                <div>
                                    <span class="d-block text-white fw-semibold small">{{ item.text }}</span>
                                    <small class="text-muted" style="font-size: 0.65rem;">GERAL</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}

                    {% if not streak_analysis.general %}
                        <div class="p-4 text-center text-muted small">Sem tend√™ncias fortes.</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}


        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const MATCH_ID = "{{ match.id }}";
    const CSRF_TOKEN = "{{ csrf_token }}";

    // --- UTILS ---
    function safeUpdateText(selector, value) {
        if (typeof value === 'number' && value % 1 !== 0) {
            value = value.toFixed(2);
        }
        const els = document.querySelectorAll(selector);
        els.forEach(el => el.textContent = value);
    }

    // --- ODDS LOGIC ---
    function renderOddsCard(title, iconClass, colorClass, choices) {
        if (!choices || choices.length < 2) return '';

        let cols = '';
        const colSize = 12 / choices.length; // 2 op√ß√µes = col-6, 3 op√ß√µes = col-4

        choices.forEach(c => {
            const probPct = (c.prob * 100).toFixed(1);
            // URL de aposta simplificada para exemplo
            cols += `
            <div class="col-${colSize}">
                <a href="/matches/${MATCH_ID}/bet/?market=${c.name}&odd=${c.odd}" class="text-decoration-none">
                    <div class="odds-choice">
                        <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem;">${c.name}</small>
                        <span class="odds-val">${c.odd}</span>
                        <span class="odds-prob text-${colorClass}">${probPct}%</span>
                    </div>
                </a>
            </div>`;
        });

        return `
        <div class="dashboard-card">
            <div class="card-header-custom">
                <h6 class="mb-0 text-${colorClass} fw-bold text-uppercase d-flex align-items-center gap-2 small">
                    <i class="${iconClass}"></i> ${title}
                </h6>
            </div>
            <div class="card-body p-3">
                <div class="row g-2 text-center">
                    ${cols}
                </div>
            </div>
        </div>`;
    }

    function fetchPreMatchOdds() {
        fetch(`/matches/${MATCH_ID}/odds/all/`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById("odds-container-sidebar");
                const loading = document.getElementById("odds-loading");
                if(loading) loading.style.display = 'none';

                if (!data || !data.markets) {
                    container.innerHTML = '<div class="alert alert-dark small">Odds indispon√≠veis.</div>';
                    return;
                }

                // Normaliza√ß√£o Simples
                const markets = data.markets.map(m => {
                    // L√≥gica simplificada de adapta√ß√£o de dados
                    if(!m.choices) return null;
                    return m;
                }).filter(Boolean);

                let html = "";

                // 1. Mercado 1x2
                const m1x2 = markets.find(m => m.market_id === 1 || m.marketName === "1x2");
                if (m1x2) {
                    // Mapeia 1, X, 2
                    const choices = [
                        m1x2.choices.find(c => c.name === '1'),
                        m1x2.choices.find(c => c.name === 'X'),
                        m1x2.choices.find(c => c.name === '2')
                    ].filter(Boolean);

                    html += renderOddsCard("Resultado Final", "bi bi-trophy-fill", "success", choices);
                }

                // 2. BTTS
                const mBtts = markets.find(m => m.marketName && m.marketName.includes("Both Teams"));
                if (mBtts) {
                     html += renderOddsCard("Ambas Marcam", "bi bi-arrow-left-right", "warning", mBtts.choices);
                }

                // 3. Over/Under 2.5
                const mGoals = markets.find(m => m.marketName && m.marketName.includes("Over/Under") && m.line === "2.5"); // Exemplo hipot√©tico de estrutura
                // Se a estrutura for diferente, ajuste o find.
                // Fallback gen√©rico para Goals
                const genericGoals = markets.find(m => m.marketName && m.marketName.includes("Goals 2.5"));
                if (genericGoals) {
                    html += renderOddsCard("Total de Gols 2.5", "bi bi-graph-up", "info", genericGoals.choices);
                }

                container.innerHTML = html;
            })
            .catch(err => {
                console.error("Erro odds:", err);
                const loading = document.getElementById("odds-loading");
                if(loading) loading.textContent = "Erro ao carregar odds.";
            });
    }

    // --- LIVE DATA LOGIC ---
    function generateLiveAnalysis(data) {
        const analysis = { insights: [] };

        // Exemplo de l√≥gica de insights
        const { xg_home, xg_away, corners_home, corners_away } = data;

        // Press√£o
        if (xg_home > (xg_away + 0.5)) analysis.insights.push("üî• Home dominando chances claras de gol.");
        if (xg_away > (xg_home + 0.5)) analysis.insights.push("üî• Away criando muito perigo nos contra-ataques.");

        // Cantos
        if ((corners_home - corners_away) >= 3) analysis.insights.push("üö© Press√£o forte do Home pelos lados.");

        return analysis;
    }

    function fetchLiveStats() {
        fetch("{% url 'post-data-stats' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": CSRF_TOKEN
            },
            body: `event_id=${MATCH_ID}`
        })
        .then(res => res.json())
        .then(data => {
            if (!data) return;

            // 1. Atualizar Placar
            safeUpdateText('.home-score', data.home_score);
            safeUpdateText('.away-score', data.away_score);
            if(data.minute) safeUpdateText('.minute-badge', data.minute + "'");

            // 2. Press√£o
            if (data.possession_home && data.possession_away) {
                const barH = document.getElementById('pressure-bar-home');
                const barA = document.getElementById('pressure-bar-away');
                if(barH) barH.style.width = `${data.possession_home}%`;
                if(barA) barA.style.width = `${data.possession_away}%`;

                safeUpdateText('#pressure-val-home', Math.round(data.possession_home));
                safeUpdateText('#pressure-val-away', Math.round(data.possession_away));
            }

            // 3. Stats Window
            if (data.analysis_live && data.analysis_live.stats_window) {
                const win = data.analysis_live.stats_window;
                safeUpdateText('.live-corners', win.corners || 0);
                safeUpdateText('.live-shots', win.shots || 0);
                const xgT = (win.xg_home || 0) + (win.xg_away || 0);
                safeUpdateText('.live-xg', xgT.toFixed(2));
            }

            // 4. Insights Din√¢micos
            const newAnalysis = generateLiveAnalysis(data);
            const list = document.querySelector('.live-insights-list');
            if (list && newAnalysis.insights.length > 0) {
                list.innerHTML = '';
                newAnalysis.insights.forEach(txt => {
                    const div = document.createElement('div');
                    div.className = 'small text-white bg-dark bg-opacity-50 p-2 rounded mb-1 border-start border-3 border-warning';
                    div.textContent = txt;
                    list.appendChild(div);
                });
            } else if (list) {
                list.innerHTML = '<div class="text-muted small">Jogo equilibrado.</div>';
            }

            // 5. Barras de Stats Gerais
            const keys = ['xg', 'shots', 'corners', 'big_chances'];
            keys.forEach(key => {
                 const h = data[`${key}_home`] || 0;
                 const a = data[`${key}_away`] || 0;
                 const total = h + a;

                 safeUpdateText(`.${key}-home`, h);
                 safeUpdateText(`.${key}-away`, a);

                 const row = document.querySelector(`[data-stat-key="${key}"]`);
                 if(row) {
                     const pH = total === 0 ? 50 : (h/total)*100;
                     const pA = total === 0 ? 50 : (a/total)*100;
                     row.querySelector('.fill-home').style.width = `${pH}%`;
                     row.querySelector('.fill-away').style.width = `${pA}%`;
                 }
            });

        })
        .catch(console.error);
    }

    // Inicializa√ß√£o
    fetchPreMatchOdds();
    fetchLiveStats();
    setInterval(fetchLiveStats, 100000); // 10s refresh
});
</script>
{% endblock %}
